<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic Duel - RPG Card Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS SAMA SEPERTI SEBELUMNYA --- */
        :root { --bg-color: #0f0c29; --accent-color: #ffd700; --primary-color: #7b2cbf; --text-color: #e0e0e0; --glass-bg: rgba(255, 255, 255, 0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #24243e, #302b63, #0f0c29); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .rpg-font { font-family: 'Cinzel', serif; }
        
        #login-section { width: 100%; max-width: 400px; padding: 2rem; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .game-logo { font-size: 2.5rem; color: var(--accent-color); margin-bottom: 2rem; text-shadow: 0 0 10px var(--accent-color); }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-field { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--primary-color); color: white; border-radius: 8px; outline: none; }
        .btn-enter { width: 100%; padding: 12px; background: linear-gradient(45deg, var(--primary-color), #9d4edd); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        
        #lobby-section { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        .lobby-header { padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .avatar { width: 50px; height: 50px; background: var(--primary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid var(--accent-color); font-weight: bold; }
        
        .lobby-main { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-match { width: 180px; height: 180px; border-radius: 50%; background: radial-gradient(circle, #5a189a, #240046); border: 4px solid var(--accent-color); color: white; font-size: 1.5rem; font-family: 'Cinzel', serif; box-shadow: 0 0 30px var(--primary-color); animation: pulse 2s infinite; cursor: pointer; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(123, 44, 191, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(123, 44, 191, 0); } 100% { box-shadow: 0 0 0 0 rgba(123, 44, 191, 0); } }

        .bottom-nav { background: rgba(0,0,0,0.8); display: flex; justify-content: space-around; padding: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-item { text-align: center; opacity: 0.5; position: relative; }
        .nav-item.active { opacity: 1; color: var(--accent-color); }
        .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 5px; }

        #matchmaking-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .cancel-btn { margin-top: 20px; background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-section">
        <h1 class="game-logo rpg-font">MYSTIC DUEL</h1>
        <p style="margin-bottom: 20px; color: #aaa;">Epic Card Battle Arena</p>
        <form id="login-form">
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" class="input-field" placeholder="Warrior Name..." required autocomplete="off">
            </div>
            <button type="submit" class="btn-enter" id="btn-login-submit">MASUK ARENA</button>
        </form>
    </div>

    <div id="lobby-section" class="hidden">
        <div class="lobby-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="avatar" id="display-avatar">?</div>
                <div>
                    <h3 class="rpg-font" id="display-username">Player</h3>
                    <small style="color: #aaa;">Status: <span id="connection-status" style="color:orange">Connecting...</span></small>
                </div>
            </div>
            <div style="background:rgba(0,0,0,0.4); padding:5px 15px; border-radius:20px; border:1px solid var(--accent-color); color:var(--accent-color);">Rank: Novice</div>
        </div>

        <div class="lobby-main">
            <button id="btn-match" class="btn-match">BATTLE<br><span style="font-size: 0.8rem; opacity: 0.8">Find Match</span></button>
            <p style="margin-top: 20px; color: #888;">Online Server: Firebase</p>
        </div>

        <div class="bottom-nav">
            <div class="nav-item"><span class="nav-icon">üé¥</span>Deck</div>
            <div class="nav-item active"><span class="nav-icon">‚öîÔ∏è</span>Lobby</div>
            <div class="nav-item"><span class="nav-icon">üèÜ</span>Rank</div>
        </div>
    </div>

    <div id="matchmaking-overlay" class="hidden">
        <h2 class="rpg-font" style="margin-bottom:10px;">MATCHMAKING</h2>
        <p id="match-status" style="color: #aaa;">Mencari lawan...</p>
        <div style="margin-top: 20px; font-size: 2rem;" id="loading-anim">‚öîÔ∏è</div>
        <button class="cancel-btn" id="btn-cancel-match">BATAL</button>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, get, remove, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCuEQQU_K8VFMrK7iu0tCvB3ujb_d75w-Y",
            authDomain: "missionimposibble-4e6a1.firebaseapp.com",
            databaseURL: "https://missionimposibble-4e6a1-default-rtdb.firebaseio.com",
            projectId: "missionimposibble-4e6a1",
            storageBucket: "missionimposibble-4e6a1.firebasestorage.app",
            messagingSenderId: "139983716532",
            appId: "1:139983716532:web:placeholder"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- VARS & UI ---
        let currentUser = null;
        let currentRoomId = null;
        let matchListener = null;

        const loginSection = document.getElementById('login-section');
        const lobbySection = document.getElementById('lobby-section');
        const btnMatch = document.getElementById('btn-match');
        const overlay = document.getElementById('matchmaking-overlay');
        const matchStatus = document.getElementById('match-status');
        const connStatus = document.getElementById('connection-status');
        const loadingAnim = document.getElementById('loading-anim');

        // Animation
        setInterval(() => {
            loadingAnim.style.transform = `rotate(${Date.now() / 5 % 360}deg)`;
        }, 50);

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value;
            if(!usernameInput) return;
            localStorage.setItem('rpg_username', usernameInput);
            document.getElementById('btn-login-submit').innerText = "Connecting...";
            signInAnonymously(auth).catch((err) => alert("Login Error: " + err.message));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                localStorage.setItem('rpg_uid', user.uid);
                
                const username = localStorage.getItem('rpg_username') || "Anonymous";
                document.getElementById('display-username').innerText = username;
                document.getElementById('display-avatar').innerText = username.charAt(0).toUpperCase();
                
                loginSection.classList.add('hidden');
                lobbySection.classList.remove('hidden');
                connStatus.innerText = "Online";
                connStatus.style.color = "#00ff00";
            }
        });

        // --- MATCHMAKING LOGIC (ROBUST) ---
        // Kita menggunakan object 'playerData' yang diperkaya dengan 'effects'
        
        function createInitialPlayerData(username, uid) {
            return {
                name: username,
                uid: uid,
                hp: 100,
                maxHp: 100,
                energy: 3,
                shield: 0,
                // INI YANG BARU: Struktur untuk efek status (Poison, Stun, dll)
                effects: {
                    poison: 0,   // Berapa turn kena racun
                    stun: 0,     // Berapa turn kena stun
                    regen: 0,    // Berapa turn dapet regen
                    burn: 0      // Berapa turn kena bakar
                }
            };
        }

        btnMatch.addEventListener('click', startMatchmaking);

        async function startMatchmaking() {
            if(!currentUser) return alert("Belum terkoneksi ke server");

            overlay.classList.remove('hidden');
            matchStatus.innerText = "Memindai arena...";
            
            const username = localStorage.getItem('rpg_username');
            const uid = currentUser.uid;
            const matchesRef = ref(db, 'matches');

            try {
                // 1. Ambil semua room (Manual Filter)
                const snapshot = await get(matchesRef);
                let foundRoomId = null;

                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const room = child.val();
                        // Cari room waiting yang BUKAN punya kita sendiri
                        if (room.status === 'waiting' && room.player1 && room.player1.uid !== uid) {
                            foundRoomId = child.key;
                        }
                    });
                }

                if (foundRoomId) {
                    // === JOIN ROOM ===
                    console.log("Room ditemukan:", foundRoomId);
                    matchStatus.innerText = "Lawan ditemukan! Memasuki arena...";

                    const roomRef = ref(db, `matches/${foundRoomId}`);
                    
                    await runTransaction(roomRef, (room) => {
                        if (room && room.status === 'waiting') {
                            room.status = 'playing'; 
                            room.player2 = createInitialPlayerData(username, uid);
                            return room;
                        }
                        return;
                    });

                    localStorage.setItem('rpg_room_id', foundRoomId);
                    localStorage.setItem('rpg_player_side', 'player2');
                    setTimeout(() => { window.location.href = 'battle.html'; }, 500);

                } else {
                    // === CREATE ROOM ===
                    console.log("Membuat room baru...");
                    matchStatus.innerText = "Menunggu penantang...";
                    
                    const newRoomRef = push(matchesRef);
                    currentRoomId = newRoomRef.key;

                    const newRoomData = {
                        status: 'waiting',
                        createdAt: Date.now(),
                        player1: createInitialPlayerData(username, uid),
                        player2: null,
                        turn: 'player1', // Host jalan duluan
                        lastLog: "Battle Start!"
                    };

                    onDisconnect(newRoomRef).remove(); // Hapus room jika DC saat nunggu
                    await set(newRoomRef, newRoomData);

                    localStorage.setItem('rpg_room_id', currentRoomId);
                    localStorage.setItem('rpg_player_side', 'player1');

                    // Listener untuk menunggu player 2
                    const roomRef = ref(db, `matches/${currentRoomId}`);
                    matchListener = onValue(roomRef, (snap) => {
                        const data = snap.val();
                        if (data && data.status === 'playing') {
                            matchStatus.innerText = "Penantang Datang!";
                            setTimeout(() => { window.location.href = 'battle.html'; }, 500);
                        }
                    });
                }

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                cancelMatch();
            }
        }

        document.getElementById('btn-cancel-match').addEventListener('click', cancelMatch);

        function cancelMatch() {
            if (currentRoomId) {
                remove(ref(db, `matches/${currentRoomId}`));
                currentRoomId = null;
            }
            if (matchListener) {
                matchListener();
                matchListener = null;
            }
            overlay.classList.add('hidden');
        }
    </script>
</body>
</html>
